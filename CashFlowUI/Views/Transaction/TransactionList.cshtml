@using CashFlowUI.Helpers
@inject IRolesManager rolesManager
@{
    ViewBag.Title = "Transaction List";
}

<h2>Transaction List</h2>

@if (User.Identity.IsAuthenticated)
{
    var userRole = rolesManager.GetUserRoleFromClaims();
    @if (await rolesManager.VerifyRoleCommandPermissionAsync(userRole, "DeleteTransactionCommand"))
    {
        <div style="text-align:left;width:100%;display:inline-block">
            <button id="deleteTransactionButton" class="btn btn-primary">Delete Transaction</button>
        </div>
    }

    <div id="areYouSureButton" style="text-align:left;width:100%;display:inline-block" hidden>
        <button class="btn btn-danger">Are you sure?</button>
    </div>
}
<table id="TransactionTable" class="table table-bordered table-striped table-hover table-responsive" style="width:100%">
    <thead>
        <tr>
            <th>Id</th>
            <th>Amount</th>
            <th>Payment Type</th>
            <th>Description</th>
            <th>Date</th>
        </tr>
    </thead>
    <tfoot>
        <tr>
            <th>Id</th>
            <th>Amount</th>
            <th>Payment Type</th>
            <th>Description</th>
            <th>Date</th>
        </tr>
    </tfoot>
</table>

@section styles {
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css" />
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/searchbuilder/1.3.2/css/searchBuilder.dataTables.min.css" />
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/datetime/1.1.2/css/dataTables.dateTime.min.css" />
}

@section scripts{

<script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/searchbuilder/1.3.2/js/dataTables.searchBuilder.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/datetime/1.1.2/js/dataTables.dateTime.min.js"></script>

<script>
    
    $(document).ready(function ($){
        var transactionId;
        var table = $("#TransactionTable")
        .DataTable({
            "dom": "Qlfrtip",
            "searchBuilder": {
                "depthLimit": 1,
                "columns": [2,4]
             },
            "ajax":{
                "url":"/Transaction/GetTransactionList",
                "type":"POST"
            },
            "columns":[
                {"data":"id"},
                {"data":"amount"},
                {"data":"paymentType"},
                {"data":"description"},
                {"data":"transactionTime"}
            ],
            "columnDefs": [
              { "type": "date", "targets": 4 }
            ],
            "conditions": {
              "date": {
                  "!null": null,
                  "null": null
               }
            },
            "processing": true,
            "serverSide":true,
            "ordering":true,
            "paging":true,
            "pagingType":"full_numbers",
            "pageLength": 10,
        });

        $('#deleteTransactionButton').click(function () {
            if(transactionId != "0"){
                $("#areYouSureButton").removeAttr('hidden');
            }            
        });

        $('#areYouSureButton').click(function () {
            if(transactionId != "0"){
                $.ajax({
                    "url":"/Transaction/DeleteTransactionById",
                    "type":"DELETE",
                    "data": {"id": transactionId },
                    "success": function(){
                        $("#TransactionTable").DataTable().row('.selected').remove().draw( false );
                    }
                });
                $("#areYouSureButton").attr('hidden', true);
            }            
        });

        $('#TransactionTable tbody').on( 'click', 'tr', function () {
            
            if ( $(this).hasClass('selected') ) {
                $(this).removeClass('selected');
                transactionId = "0";
            }
            else {
                table.$('tr.selected').removeClass('selected');
                $(this).addClass('selected');
                transactionId = table.row('.selected').data()["id"];
                
            }
        });

        
    });
</script>
}